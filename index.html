<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spectrum Analyzer iOS Fix</title>
    <style>
        body { background: #121212; color: #0f0; font-family: sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; overflow-x: hidden; }
        canvas { width: 95%; height: auto; background: #000; border: 1px solid #333; margin-top: 10px; }
        .controls { width: 95%; margin: 15px 0; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        .peak-list { color: #fff; font-size: 0.9rem; margin: 10px 0; text-align: center; min-height: 1.2em; }
        .peak-list span { color: #0f0; margin: 0 5px; }
        button { padding: 15px 25px; font-size: 1rem; cursor: pointer; background: #0f0; border: none; font-weight: bold; border-radius: 8px; -webkit-appearance: none; }
        #debug { color: #ff0; font-size: 0.7rem; width: 90%; word-wrap: break-word; }
        .slider-group { display: flex; flex-direction: column; color: #ccc; font-size: 0.7rem; align-items: center; }
    </style>
</head>
<body>

    <div id="debug">Status: Ready (Tap Start)</div>
    <canvas id="visualizer" width="600" height="300"></canvas>
    <div class="peak-list" id="peakDisplay">Peaks will appear here</div>

    <div class="controls">
        <button id="toggleBtn">START</button>
        <div class="slider-group">
            <label>Min: <span id="minVal">0</span>Hz</label>
            <input type="range" id="minFreq" min="0" max="5000" value="0">
        </div>
        <div class="slider-group">
            <label>Max: <span id="maxVal">15000</span>Hz</label>
            <input type="range" id="maxFreq" min="5000" max="22050" value="15000">
        </div>
    </div>

<script>
let audioCtx, analyser, dataArray, animationId;
const canvas = document.getElementById('visualizer');
const ctx = canvas.getContext('2d');
const toggleBtn = document.getElementById('toggleBtn');
const debug = document.getElementById('debug');

async function init() {
    try {
        // iOS対策: AudioContextをタップイベント内で生成
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AudioContext();

        // iOS対策: サスペンド状態で始まることが多いため明示的にresume
        if (audioCtx.state === 'suspended') {
            await audioCtx.resume();
        }

        debug.innerText = "Requesting Microphone...";
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
        
        const source = audioCtx.createMediaStreamSource(stream);
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 1024; // iPhoneの負荷を考慮し少し下げる
        source.connect(analyser);

        dataArray = new Uint8Array(analyser.frequencyBinCount);
        debug.innerText = "Running...";
        render();
    } catch (err) {
        debug.innerText = "Error: " + err.name + " - " + err.message;
        console.error(err);
    }
}

function render() {
    animationId = requestAnimationFrame(render);
    analyser.getByteFrequencyData(dataArray);

    const minF = parseInt(document.getElementById('minFreq').value);
    const maxF = parseInt(document.getElementById('maxFreq').value);
    document.getElementById('minVal').innerText = minF;
    document.getElementById('maxVal').innerText = maxF;

    ctx.fillStyle = 'black';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    const binSize = audioCtx.sampleRate / analyser.fftSize;
    let points = [];

    ctx.beginPath();
    ctx.strokeStyle = '#00ff00';
    ctx.lineWidth = 2;

    for (let i = 0; i < dataArray.length; i++) {
        const freq = i * binSize;
        if (freq < minF || freq > maxF) continue;
        const x = ((freq - minF) / (maxF - minF)) * canvas.width;
        const y = canvas.height - (dataArray[i] / 255) * canvas.height;
        if (points.length === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
        points.push({ x, y, freq, val: dataArray[i] });
    }
    ctx.stroke();

    const peaks = [...points].sort((a, b) => b.val - a.val).slice(0, 5);
    document.getElementById('peakDisplay').innerHTML = peaks.map(p => `<span>${Math.round(p.freq)}Hz</span>`).join('');
}

toggleBtn.addEventListener('click', async () => {
    if (!audioCtx) {
        await init();
        toggleBtn.innerText = "PAUSE";
    } else {
        if (audioCtx.state === 'running') {
            await audioCtx.suspend();
            toggleBtn.innerText = "RESUME";
        } else {
            await audioCtx.resume();
            toggleBtn.innerText = "PAUSE";
        }
    }
});
</script>
</body>
</html>
